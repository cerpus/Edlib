volumes:
  hub_storage:

services:
  hub:
    image: edlib:php-latest
    depends_on:
      hub-startup: { condition: service_completed_successfully }
    env_file:
      - .env
    environment:
      - HTTPS=1
    healthcheck:
      test: [CMD, nc, -z, localhost, '9000']
    platform: linux/amd64
    volumes:
      - hub_storage:/app/storage

  hub-cron:
    image: edlib:php-latest
    command: [php, artisan, 'schedule:work']
    depends_on:
      hub-startup: { condition: service_completed_successfully }
    env_file:
      - .env
    platform: linux/amd64
    volumes:
      - hub_storage:/app/storage

  hub-startup:
    image: edlib:php-latest
    command: [prod-startup.sh]
    env_file:
      - .env
    platform: linux/amd64
    volumes:
      - hub_storage:/app/storage
      - ./startup.sh:/usr/local/bin/prod-startup.sh:ro

  hub-web:
    image: edlib:web-latest
    depends_on:
      hub: { condition: service_healthy }
    env_file:
      - .env
    environment:
      PHP_FPM_HOST: hub:9000
    platform: linux/amd64
    volumes:
      - hub_storage:/app/storage:ro
    ports:
      - 80:80
      - 443:443

  hub-worker:
    image: edlib:php-latest
    command: [php, artisan, 'queue:work']
    depends_on:
      hub-startup: { condition: service_completed_successfully }
    env_file:
      - .env
    platform: linux/amd64
    volumes:
      - hub_storage:/app/storage
